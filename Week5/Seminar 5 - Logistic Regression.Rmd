---
title: "Logistic, Ordinal, and Multinomial Regression"
author: "Ilya Lyapin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Data Preparation

## Loading Libraries and Data

```{r load-libraries}
library(foreign)
library(dplyr)
```

```{r load-data}
happ1 <- read.spss("Russia_WVS_EVS.sav", to.data.frame = TRUE)

happ <- happ1 %>% 
  dplyr::select(E023, G007_34_B, X001, X007, X028, F050, X003, X011)

lookup <- c(interest = "E023", trust_first = "G007_34_B", sex = "X001", 
            marital = "X007", employm = "X028", relig = "F050",
            age = "X003", children = "X011")

happ <- dplyr::rename(happ, all_of(lookup))
names(happ)
```

```{r initial-summary}
summary(happ)
```

## Variable Recoding

```{r recode-age}
# Age: convert to numeric
happ$age <- ifelse(happ$age == "82 and older", 82, as.character(happ$age))
happ$age <- as.numeric(happ$age)
```

```{r recode-trust}
# Trust: collapse into binary
happ$trust_first <- as.factor(ifelse(
  happ$trust_first == "Trust completely" | happ$trust_first == "Trust somewhat", 
  "Trust", 
  as.character(happ$trust_first)
))
happ$trust_first <- as.factor(happ$trust_first)
summary(as.factor(happ$trust_first))
```

```{r recode-marital}
# Marital status: collapse into 3 categories
happ$marital3 <- as.factor(ifelse(
  happ$marital == "Married" | happ$marital == "Living together as married", 
  "Not single", 
  ifelse(happ$marital == "Single/Never married", "Single", "Not married")
))
summary(happ$marital3)
```

```{r recode-employment}
# Employment: collapse into 3 categories
happ$employm1 <- as.factor(ifelse(
  happ$employm == "Full time (30h a week or more)" | 
    happ$employm == "Part time (less then 30 hours a week)" |
    happ$employm == "Self employed", 
  "Employed", 
  ifelse(
    happ$employm == "Unemployed" | 
      happ$employm == "Housewife (not otherwise employed)" |
      happ$employm == "Other", 
    "Unemployed", 
    ifelse(
      happ$employm == "Student" | happ$employm == "Retired/pensioned",
      "Retired/ Student", 
      as.character(happ$employm)
    )
  )
))
summary(happ$employm1)
```

```{r recode-children}
# Children: collapse 3+ into one category
happ$children3 <- as.factor(ifelse(
  happ$children == "3 children" | happ$children == "4 children" | 
    happ$children == "5 children and more", 
  "3 or more", 
  as.character(happ$children)
))
summary(happ$children3)

happ$children3 <- relevel(happ$children3, ref = "No child")
```

```{r final-summary}
summary(happ)
```

---

# Binary Logistic Regression

## Creating Binary Outcome

```{r create-binary}
table(happ$interest)
barplot(table(happ$interest))

# Binary: 1 = interested (very/somewhat), 0 = not interested
happ$interest2 <- ifelse(as.numeric(happ$interest) < 3, 1, 0)
table(happ$interest, happ$interest2)
table(happ$interest2)
```

## Handling Missing Data

```{r drop-na}
happ <- na.exclude(happ)
dim(happ)  # we lost 290 cases
```

## Cross-tabulations

```{r crosstabs}
table(happ$interest2, happ$trust_first)
table(happ$interest2, happ$sex)
table(happ$interest2, happ$relig)
table(happ$interest2, happ$marital3)
table(happ$interest2, happ$employm1)
table(happ$interest2, happ$children3)
```

## Fitting the Model

```{r binary-model}
reg1 <- glm(interest2 ~ sex + age + marital3, data = happ, family = "binomial")
summary(reg1)
exp(reg1$coefficients)
```

```{r binary-viz}
library(sjPlot)
tab_model(reg1)
plot_model(reg1)
plot_model(reg1, type = "pred")
```

## Marginal Effects

```{r marginal-effects}
library(effects)
m1.eff <- allEffects(reg1)
m1.eff
```

## Model Fit

```{r baseline-accuracy}
prop.table(table(happ$interest2))  # baseline: 30.1% interested
```

```{r predictions}
happ$yhat <- predict.glm(reg1, type = 'response')
happ$yhat1 <- ifelse(happ$yhat < 0.5, 0, 1)
table(happ$interest2, happ$yhat1)
```

```{r fit-metrics}
library(ROSE)
accuracy.meas(happ$interest2, happ$yhat, threshold = 0.5)

library(caret)
confusionMatrix(as.factor(happ$interest2), as.factor(happ$yhat1))
```

```{r roc-curve}
library(pROC)
f1 <- roc(happ$interest2, happ$yhat1)
plot(f1, col = "red")
auc(f1)
```

---

# Ordinal Logistic Regression

```{r ordinal-model}
library(MASS)
reg2 <- polr(interest ~ sex + age + trust_first + marital3, data = happ)
summary(reg2)
tab_model(reg2)
```

```{r ordinal-viz}
plot_model(reg2)
plot_model(reg2, type = "pred")
```

```{r ordinal-effects}
library(effects)
m2.eff <- allEffects(reg2)
m2.eff
plot(m2.eff, 'age', ylab = "Predicted prob(interest)", xlab = "age")
```

## Model Fit

```{r ordinal-fit}
chisq.test(happ$interest, predict(reg2))
chisq.test(happ$interest, predict(reg2))$stdres

predictMod <- predict(reg2, happ)
cTab <- table(happ$interest, predictMod)
mean(as.character(happ$interest) != as.character(predictMod))
(CCR <- sum(diag(cTab)) / sum(cTab))
```

## Testing Proportional Odds Assumption

```{r brant-test}
library(brant)
brant::brant(reg2)  # should be MORE than 5%, esp. Omnibus
# In our case, proportional odds assumption is violated
```

---

# Multinomial Logistic Regression

```{r multinomial-model}
library(nnet)
reg3 <- multinom(interest ~ sex + age + employm1, data = happ)
summary(reg3)
tab_model(reg3)
```

```{r multinomial-viz}
plot_model(reg3)
plot_model(reg3, type = "pred")
```

```{r multinomial-effects}
library(effects)
m3.eff <- allEffects(reg3)
m3.eff
plot(m3.eff, 'age', ylab = "Predicted prob(interest)", xlab = "age")
```

## Likelihood Ratio Tests

```{r lrt-tests}
library(lmtest)
lrtest(reg3, "employm1")  # Chi-Square=19.698, p=0.01987*
lrtest(reg3, "age")       # Chi-Square=11.735, p=0.00835**
```

## Model Fit

```{r multinomial-fit}
chisq.test(happ$interest, predict(reg3))
chisq.test(happ$interest, predict(reg3))$stdres
```

---

# Student Tasks

## Task 1: Descriptive Statistics

Create plots for all variables in the dataset. Use appropriate plot types for categorical and continuous variables.

```{r task1}
# YOUR CODE HERE

```

## Task 2: Bivariate Tests

Run chi-square tests for each categorical predictor against `interest2`. Run a t-test for age. Which variables are significantly associated with political interest?

```{r task2}
# YOUR CODE HERE

```

## Task 3: Improve the Binary Model

Add more predictors to `reg1` (e.g., `trust_first`, `employm1`, `children3`, `relig`). Compare models using AIC. Which model fits best?

```{r task3}
# YOUR CODE HERE

```

## Task 4: Threshold Optimization

Test different classification thresholds (0.3, 0.4, 0.6) instead of 0.5. How do sensitivity and specificity change? Which threshold would you recommend?

```{r task4}
# YOUR CODE HERE

```

## Task 5: Compare Ordinal and Multinomial

Fit ordinal and multinomial models with the same predictors (`sex + age + employm1`). Compare their classification accuracy. Which performs better?

```{r task5}
# YOUR CODE HERE

```

---

# Session Info

```{r session-info}
sessionInfo()
```
